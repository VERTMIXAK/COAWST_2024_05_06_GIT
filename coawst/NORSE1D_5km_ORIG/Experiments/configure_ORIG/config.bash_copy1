#!/bin/bash
source ~/.runROMSintel

# Choose the cast number

n=915
mixing='GLS'
mode='mesoNoTides'

#cp -r templateDir ..

\rm getNumbers.m
perl -pe "s/XXX/$n/" util/getNumbersTemplate.m > getNumbers.m


module purge
. /etc/profile.d/modules.sh
module load matlab/R2013a
matlab -nodisplay -nosplash < getNumbers.m


lon=`head -1 latlon.txt | rev | cut -d ' ' -f1 |rev`
lat=`head -2 latlon.txt | tail -1 | rev | cut -d ' ' -f1 |rev`

echo "lat " $lat
echo "lon " $lon

myDate=`head -3 latlon.txt | tail -1 | cut -c 1-8`
myDate=`date -d $myDate +"%Y-%m-%d"`

myTimeGMT=`head -3 latlon.txt | tail -1 | cut -c 10-15`

myTime=`tail -1 latlon.txt | cut -d '.' -f2`

echo $myDate
echo $myTimeGMT

dayN=`grep $myDate /import/home/jgpender/addl_Scripts/dayConverterCommas.txt | cut -d ',' -f2`

#myHour=`tail -1 latlon.txt | cut -c 10-11`
#myHour=`echo "scale=4;  $myHour / 24 " | bc`
#
#myMin=`tail -1 latlon.txt | cut -c 12-13`
#myMin=`echo "scale=4; $myMin / 24 / 60 " | bc`
#
#mySec=`tail -1 latlon.txt | cut -c 14-15`
#mySec=`echo "scale=4; $mySec / 24 / 60 / 60 " | bc`

#echo $myTime
#echo $myHour $myMin $mySec

#dStart=`echo "scale=1; $dayN + $myHour + $myMin + $mySec" | bc -l`
#dStart=`echo "scale=2; 100 * $dStart / 100" | bc `
#dStart=`echo " $dStart / 100 " | bc`

dStart=$dayN'.'$myTime

echo "dStart " $dStart




#############

# Make a new grid file

echo " "
echo " !!!  make a new grid file"
echo " "

cd ../../InputFiles/Gridpak_scripted


\rm NORSE1D_5km.nc
perl -pe "s/XXX/$lon/" 		hackGrid.bash_template 	> dum
perl -pe "s/YYY/$lat/"      dum						> hackGrid.bash
bash hackGrid.bash




################

# Make a new IC file
cd ../B*/ini*
\rm -r __* remap*.nc
#perl -pe "s/XXX/$dStart/"      makeGeneric.m_template > makeGeneric.m

source ~/.runPycnal
python make_remap*
python make_ic*
mv source_* /import/c1/VERTMIX/jgpender/coawst/NORSE1D_5km/Experiments/configure/IC.nc

#module purge
#. /etc/profile.d/modules.sh
#module load matlab/R2013a
#matlab -nodisplay -nosplash < makeGeneric.m

cd ../../Gridpak_scripted
mv NORSE1D_5km.nc /import/c1/VERTMIX/jgpender/coawst/NORSE1D_5km/Experiments/configure/


cd /import/c1/VERTMIX/jgpender/coawst/NORSE1D_5km/Experiments/configure





###########

# Update all the fields for zero motion and new S/T profile

perl -pe "s/XXX/$n/" util/customizeST_template.m 	> dum
perl -pe "s/YYY/$dStart/" dum 						> customizeST.m

module purge
. /etc/profile.d/modules.sh
module load matlab/R2013a
matlab -nodisplay -nosplash < customizeST.m



#################

# subset the surface forcing files and make them laterally uniform

cd ../../InputFiles/Forcing
pwd

perl -pe "s/XXX/$lon/"      subsetForcing_template.m	> dum
perl -pe "s/YYY/$lat/"      dum                     	> subsetForcing.m

matlab -nodisplay -nosplash < subsetForcing.m

cd -








############

# Move everything to a new experiment directory


dirName="NORSE1D_5km__cast_"$n"__"$myDate"_"$myTimeGMT"__"$lon"E__"$lat"N__"$mode"_"$mixing
echo ' '
echo 'experiment directory:'
echo $dirName

oceanName="ocean_niskine1d_2km.in_"$mode"_"$mixing
#echo "oceanName" $oceanName

coawstName="coawstM_"$mode"_"$mixing
#echo "coawstName "$coawstName



mkdir 											../$dirName
mkdir               							../$dirName/netcdfOutput

perl -pe "s/YYY/$dStart/" util/$oceanName        > ../$dirName/$oceanName

cp util/$coawstName								../$dirName
mv IC.nc 										../$dirName
mv NORSE*.nc									../$dirName
cp -r ../../InputFiles/Forcing						../$dirName


echo "/opt/scyld/openmpi/1.10.7/intel/bin/mpirun -np 1 coawstM* ocean* > log; bash /import/home/jgpender/addl_Scripts/timeROMS/getRunTime.bash >> log"  > ../$dirName/run
chmod gou+x                                     ../$dirName/run
